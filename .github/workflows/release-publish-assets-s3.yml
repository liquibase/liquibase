name: Release Publish Assets to S3

run-name: "Publish Assets to S3 - v${{ inputs.version }}${{ inputs.dry_run && ' (Dry Run)' || '' }}"

on:
  workflow_call:
    inputs:
      version:
        description: "Version to publish"
        required: true
        type: string
      dry_run:
        description: "Flag to indicate if this is a dry-run"
        required: false
        type: boolean
        default: false
  
  workflow_dispatch:
    inputs:
      version:
        description: "Version to publish"
        required: true
        type: string
      dry_run:
        description: "Flag to indicate if this is a dry-run"
        required: false
        type: boolean
        default: false

permissions:
  contents: read
  id-token: write

jobs:
  publish-assets-s3:
    name: Publish OSS released assets to s3 bucket liquibaseorg-origin
    runs-on: ubuntu-22.04
    if: ${{ inputs.dry_run == false }}
    steps:
      - name: Download released assets
        uses: robinraju/release-downloader@v1.12
        with:
          repository: "liquibase/liquibase"
          latest: true
          fileName: "*"
          out-file-path: "./${{ inputs.version }}-released-assets"

      - name: Get current timestamp
        id: timestamp
        run: echo "timestamp=$(date +%Y%m%d-%H%M%S)" >> $GITHUB_ENV

      - name: Configure AWS credentials for vault access
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ secrets.LIQUIBASE_VAULT_OIDC_ROLE_ARN }}
          aws-region: us-east-1

      - name: Get secrets from vault
        id: vault-secrets
        uses: aws-actions/aws-secretsmanager-get-secrets@v2
        with:
          secret-ids: |
            ,/vault/liquibase
          parse-json-secrets: true

      - name: Configure AWS credentials for prod account access
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ env.AWS_PROD_GITHUB_OIDC_ROLE_ARN_BUILD_LOGIC }}
          aws-region: us-east-1

      - name: Publish released assets to s3 bucket
        run: |
          aws s3 sync "./${{ inputs.version }}-released-assets" s3://liquibaseorg-origin/oss-released-assets/${{ inputs.version }}-released-assets-${{ env.timestamp }}/ --only-show-errors
